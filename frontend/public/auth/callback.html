<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PicklePro Auth</title>
    <style>
        body {
            background: #0f172a;
            color: #e2e8f0;
            font-family: -apple-system, system-ui, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 16px;
            border: 3px solid #1e293b;
            border-top-color: #84cc16;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        a {
            color: #84cc16;
            text-decoration: underline;
            font-size: 16px;
        }

        .debug {
            font-size: 10px;
            color: #475569;
            margin-top: 20px;
            word-break: break-all;
        }
    </style>
</head>

<body>
    <div class="container" id="content">
        <div class="spinner"></div>
        <p>Redirecting to PicklePro...</p>
    </div>
    <script>
        (function () {
            // Collect params from hash fragment (Google implicit flow puts tokens here)
            var hash = window.location.hash.substring(1);
            var hashParams = new URLSearchParams(hash);

            // Extract return scheme from state parameter
            var stateRaw = hashParams.get('state') || '';
            var returnUri = 'picklepro://auth/callback'; // default for standalone APK
            try {
                var stateObj = JSON.parse(decodeURIComponent(stateRaw));
                if (stateObj && stateObj.returnUri) {
                    returnUri = stateObj.returnUri;
                }
            } catch (e) {
                console.log('State decode failed, using default:', e);
            }

            // Remove state from forwarded params
            hashParams.delete('state');
            var tokenParams = hashParams.toString();

            // Build the deep link
            var separator = returnUri.indexOf('?') >= 0 ? '&' : '?';
            var deepLink = returnUri + separator + tokenParams;

            // On Android, Chrome blocks direct custom-scheme:// navigation from HTTPS pages.
            // Use Android's intent:// URI format which explicitly targets the app.
            var isAndroid = /android/i.test(navigator.userAgent);

            if (isAndroid && returnUri.startsWith('exp://')) {
                // Extract host:port from exp://host:port
                var expHost = returnUri.replace('exp://', '').split('/')[0];
                var intentUri = 'intent://' + expHost + separator + tokenParams +
                    '#Intent;scheme=exp;package=host.exp.exponent;end';
                window.location.href = intentUri;
            } else {
                window.location.href = deepLink;
            }

            // Fallback after 3 seconds
            setTimeout(function () {
                document.getElementById('content').innerHTML =
                    '<p style="margin-bottom:16px">If the app didn\'t open automatically:</p>' +
                    '<p><a href="' + deepLink + '">Tap here to open PicklePro</a></p>' +
                    (isAndroid && returnUri.startsWith('exp://') ?
                        '<p style="margin-top:12px"><a href="intent://' + returnUri.replace('exp://', '').split('/')[0] +
                        separator + tokenParams + '#Intent;scheme=exp;package=host.exp.exponent;end">Or try this link for Expo Go</a></p>' : '') +
                    '<p class="debug">Return URI: ' + returnUri + '</p>';
            }, 3000);
        })();
    </script>
</body>

</html>